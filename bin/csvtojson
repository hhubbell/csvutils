#!/usr/bin/env python
#
# Create JSON from a csv and return the result to stdout.
#

import csvutils as cu
import json
import sys

def makejson(header, rows):
    """
    Create a json object
    :param header:      CSV header
    :param rows:        CSV rows
    :return dict:       Serializable dict
    """
    for row in rows:
        yield {k: v for k, v in zip(header, row)}

if __name__ == '__main__':
    parser = cu.default_arguments()
    parser.add_argument('-p', '--pretty',
        action='store_true',
        help='Try to make the json human readable')

    args = parser.parse_args()

    infile = args.infile
    outfile = sys.stdout
    delim = args.delim.decode('string-escape')
    tabs = cu.TAB_WIDTH if args.pretty else None

    header, rows = cu.read(infile, header=args.header, delimiter=delim)

    if header is None and args.header is False:
        header = cu.generic_header(len(rows[0]))

    json.dump(list(makejson(header, rows)), outfile, indent=tabs, sort_keys=True)
